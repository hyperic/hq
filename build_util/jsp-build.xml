  <!-- Precompile JSP's located in ${ear.dir}/hq.war -->

  <target name="precompile-jsp-check">
    <uptodate property="precompile-jsp.notrequired"
              targetfile="${ear.dir}/hq.war/WEB-INF/lib/hq_jsp.jar">
      <srcfiles dir="${ear.dir}/hq.war">
        <include name="**/*.jsp"/>
        <include name="**/web.xml"/>
       </srcfiles>
    </uptodate>
    <echo message="Checking ${ear.dir}/hq.war ${precompile-jsp.notrequired}"/>
    <condition property="precompiled-jsps.available" value="true">
      <isset property="precompile-jsp.notrequired"/>
    </condition>
  </target>

  <target name="precompile-jsp" 
          description="Precompile JSPs into Java Source"
          depends="precompile-jsp-check,init-taskdefs,pack"
          unless="precompile-jsp.notrequired">
    <path id="jsp-jars" >
       <path refid="alljars" />
       <path location="${build.dir}/classes" />
    </path>
    <taskdef classname="org.apache.jasper.JspC" name="jasper2" >
      <classpath refid="jsp-jars"/>
    </taskdef>

    <mkdir dir="${build.dir}/jsp/src" />
    <mkdir dir="${build.dir}/jsp/classes" />
    <mkdir dir="${ear.dir}/hq.war/WEB-INF/classes" />
    <delete file="${ear.dir}/hq.war/WEB-INF/web.xml" />
    <copy file="${webapp.home}/WEB-INF/web.xml"
          todir="${ear.dir}/hq.war/WEB-INF/" />

    <jasper2 compile="false"
             validateXml="false"
             uriroot="${ear.dir}/hq.war"
             webXmlFragment="${build.dir}/jsp/generated_web.xml"
             outputDir="${build.dir}/jsp/src" />

    <loadfile property="generated_ROOT_web.xml"
              srcFile="${build.dir}/jsp/generated_web.xml"  />

    <replace file="${ear.dir}/hq.war/WEB-INF/web.xml"
             token="&lt;!--GENERATED_JSPS--&gt;" value="${generated_ROOT_web.xml}" />

    <javac destdir="${build.dir}/jsp/classes"
           optimize="off"
           source="${hq.javac.source}"
           debug="off">
       <classpath refid="jsp-jars"/>
       <src path="${build.dir}/jsp/src"/>
       <include name="**/*.java"/>
   </javac>
   <jar jarfile="${ear.dir}/hq.war/WEB-INF/lib/hq_jsp.jar" >
     <fileset dir="${build.dir}/jsp/classes" includes="**" />
   </jar>
    <delete>
        <fileset dir="${ear.dir}/hq.war" includes="**/*.jsp"/>
    </delete>
  </target>

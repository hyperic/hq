<?xml version="1.0"?>

<project name="hqu-build" basedir="..">

	<property name="rendit_sys.dir" value="${hq.home}/src/org/hyperic/hq/hqu/rendit" />
	<property name="hqu.deployed.dir" value="${jboss.home}/server/default/deploy/hq.ear/hq.war/hqu" />
	<property name="hqu.deployed.rendit_sys.dir" value="${jboss.home}/server/default/deploy/hq.ear/rendit_sys" />
	<property name="compile.groovy.classes" value="${build.dir}/classes-groovy" />

	<target name="hqu-init" unless="hqu-init.notrequired">
		<macrodef name="hqu-copy">
			<attribute name="eardir" />
			<attribute name="wardir" />
			<sequential>
				<mkdir dir="@{eardir}/rendit_sys/org/hyperic/hq/hqu/rendit" />
				<copy todir="@{eardir}/rendit_sys/org/hyperic/hq/hqu/rendit">
					<fileset dir="${rendit_sys.dir}">
						<include name="**/*.groovy" />
						<include name="**/*.properties" />
						<exclude name="**/*.java" />
					</fileset>
				</copy>
				<mkdir dir="@{wardir}/hqu" />
				<copy todir="@{wardir}/hqu">
					<fileset dir="${basedir}/ui_plugins">
                                                <exclude name="hqapi1/.git/**" />
						<exclude name="scaffold/**" />
						<exclude name="extra/**" />
						<exclude name="old/**" />
					</fileset>
				</copy>
			</sequential>
		</macrodef>

		<macrodef name="hqu-redeploy-plugin">
			<attribute name="wardir" />
			<attribute name="plugin" />
			<sequential>
				<delete dir="${hqu.deployed.dir}/@{plugin}" />
				<sleep seconds="2" />
				<copy todir="@{wardir}/hqu/@{plugin}">
					<fileset dir="${basedir}/ui_plugins/@{plugin}" />
				</copy>
			</sequential>
		</macrodef>

		<taskdef name="groovydoc" classname="org.codehaus.groovy.ant.Groovydoc" classpathref="alljars" />

		<!-- compile and add the groovy scripts to hq.jar -->
		<path id="compile.classpath">
			<path refid="alljars" />
			<path refid="testjars" />
			<path location="${build.dir}/classes" />
		</path>

		<taskdef name="groovyc" classname="org.codehaus.groovy.ant.Groovyc">
			<classpath refid="compile.classpath" />
		</taskdef>

		<mkdir dir="${compile.groovy.classes}" />
		<groovyc destdir="${compile.groovy.classes}" srcdir="${rendit_sys.dir}" listfiles="true">
			<classpath refid="compile.classpath" />
		</groovyc>

		<!-- compiled classes -->
		<jar file="${ear.dir}/hqu-groovy.jar" basedir="${compile.groovy.classes}">
			<include name="org/hyperic/hq/hqu/rendit/**" />
		</jar>

		<!-- script sources -->
		<jar file="${ear.dir}/hqu-groovy-source.jar" basedir="${hq.home}/src/">
			<include name="org/hyperic/hq/hqu/rendit/**/*.groovy" />
		</jar>
		
		<property name="hqu-init.notrequired" value="true" />
	</target>

	<!-- HQU == UI Plugins -->
	<target name="hqu-deploy" depends="hqu-init">
		<!-- Default eardir & wardir to the running jboss if not defined -->
		<property name="eardir" value="${jboss.home}/server/default/deploy/hq.ear" />
		<property name="wardir" value="${jboss.home}/server/default/deploy/hq.ear/hq.war" />
		<hqu-copy eardir="${eardir}" wardir="${wardir}" />
	</target>

	<target name="hqu-undeploy" depends="hqu-init">
		<delete dir="${hqu.deployed.dir}" />
		<mkdir dir="${hqu.deployed.dir}" />
		<delete dir="${hqu.deployed.rendit_sys.dir}" />
	</target>

	<target name="hqu-redeploy-plugin" depends="hqu-init">
		<hqu-redeploy-plugin wardir="${jboss.home}/server/default/deploy/hq.ear/hq.war" plugin="${plugin}" />
	</target>

	<target name="hqu-gen-scaffold" depends="hqu-init">
		<echo>
    Use this task to generate a basic HQ plugin.

    Syntax:  hqu-gen-scaffold -Dplugin=cool -Dcontroller=Registry -DcontrollerDir=registry

    Where:  -Dplugin=         used to specify the short, plugin directory name
            -Dcontroller=     Must be upper-case, specifies controlller in /app (ex:  Alert)
            -DcontrollerDir=  must be lower-case, specifies views in /views/{dir}  (ex: alert)
    </echo>

		<fail unless="plugin" />
		<fail unless="controller" />
		<fail unless="controllerDir" />

		<property name="targetDir" value="${basedir}/ui_plugins/${plugin}" />
		<available property="target.exists" file="${targetDir}" />
		<fail if="target.exists">
       Plugin at ${targetDir} already exists.
    </fail>

		<copy todir="${basedir}/ui_plugins/${plugin}" overwrite="false" verbose="true">
			<fileset dir="${hq.home}/ui_plugins/scaffold" />
		</copy>

		<replace dir="${targetDir}" token="@PLUGIN_NAME@" value="${plugin}" />
		<replace dir="${targetDir}" token="@CONTROLLER_NAME@" value="${controller}" />
		<replace dir="${targetDir}" token="@CONTROLLER_DIR@" value="${controllerDir}" />
		<replace dir="${targetDir}" token="@NEW_PLUGIN_PATH@" value="${targetDir}" />

		<move file="${targetDir}/etc/scaffold_i18n.properties" overwrite="false" tofile="${targetDir}/etc/${plugin}_i18n.properties" />

		<move file="${targetDir}/app/SampleController.groovy" overwrite="false" tofile="${targetDir}/app/${controller}Controller.groovy" />

		<move file="${targetDir}/views/sample" overwrite="false" tofile="${targetDir}/views/${controllerDir}" />

		<echo>
                Your plugin is in:           ${targetDir}
                To deploy it to your server:  ant hqu-redeploy-plugin -Dplugin=${plugin}
                The URL to access it:  localhost:7080/hqu/${plugin}/${controllerDir}/index.hqu
        </echo>
	</target>

	<target name="hqu-doc" depends="hqu-init,init-taskdefs">

		<taskdef name="groovydoc" classname="org.codehaus.groovy.ant.Groovydoc" classpathref="alljars" />

		<groovydoc destdir="${build.dir}/hqudoc" sourcepath="${build.dir}/hq.ear/rendit_sys" use="true" windowtitle="groovydoc" private="false" />
	</target>

</project>

<?xml version="1.0"?>

<project name="setup" default="all" basedir=".">
  <property name="oss.license.file" value="${install.dir}/../LICENSE.txt"/>    
  <property name="oss.gpl.license.file" value="${install.dir}/../COPYING.txt"/>    
  <property name="oss.ee.license.file" value="${install.dir}/../open_source_licenses.txt"/>    
  <property name="vfabric.license.jar.name" value="client-parent-1.2.0-bin.jar"/>

  <!-- true for text based installs -->
  <available property="server.pgsql.available"
             file="${install.dir}/data/hqdb/pgsql.tar.gz"/>
    
   <path id="alljars">
         <fileset dir="${install.dir}/lib" includes="*.jar"/>
  </path>   

  <target name="init-taskdefs">
    <echo>^^^DEBUG: Loading taskdefs...</echo>
     <taskdef resource="net/sf/antcontrib/antcontrib.properties"
              classpathref="alljars"/>
     <taskdef resource="org/hyperic/tools/ant/ant-tools.properties"
              classpathref="alljars"/>
     <echo>^^^DEBUG: Taskdefs loaded</echo>
  </target>
    
  <target name="load-basics" depends="init-taskdefs">
    <property file="${install.dir}/data/version.properties"/>
    <echo>^^^INFO: Initializing Hyperic HQ ${version} Installation...</echo>

    <available property="use.builtin.jre" file="${install.dir}/jres"/>

    <condition property="isWin32">
      <os family="windows"/>
    </condition>

    <if>
      <equals arg1="${install.mode}" arg2="upgrade"/>
      <then>
         <echo>^^^INFO:
*
******************************************************************************************************************
Warning: There is no undo for the upgrade process.${line.separator}
Before upgrading Hyperic Server, archive your existing Hyperic Server directory and back up the Hyperic Database, ${line.separator}
to ensure that you can roll back to the prior version if desired.
******************************************************************************************************************
${line.separator}Press enter to continue...
          </echo>
        <input />
        <property name="setup.upgrade" value="true"/>
      </then>
    </if>
  	
    <absolutePath property="base"
                  path="${install.dir}/.."
                  failOnMissing="true"/>

  </target>

  <!-- The server uses a 1.6 JRE. -->
  <target name="pick-server-jre" if="use.builtin.jre">
    <condition property="jre.tar.name" value="amd64-linux-1.7_101.tar.gz">
        <available file="${install.dir}/jres/amd64-linux-1.7_101.tar.gz"/>
    </condition>
    <condition property="jre.tar.name" value="sparc-sun-solaris-1.7_101.tar.gz">
        <available file="${install.dir}/jres/sparc-sun-solaris-1.7_101.tar.gz"/>
    </condition>
    <condition property="jre.exe.name" value="x86_64-win-1.7_101.exe">
        <available file="${install.dir}/jres/x86_64-win-1.7_101.exe"/>
     </condition>
  </target>

  <target name="install-jre-tar" if="jre.tar.name">
    <echo>^^^INFO:
      Unpacking JRE ${jre.tar.name} to: ${destination}...
    </echo>
    <untar src="${install.dir}/jres/${jre.tar.name}"
           dest="${destination}"
           compression="gzip"/>
  </target>

  <target name="install-jre-exe" if="jre.exe.name">
    <echo>^^^INFO:
      Unpacking JRE ${jre.exe.name} to: ${destination}...
    </echo>
    <exec executable="${install.dir}/jres/${jre.exe.name}">
      <arg line="-y -o'${destination}'"/>
    </exec>
  </target>

 

  <target name="install-server-jre" depends="pick-server-jre" if="use.builtin.jre">
    <echo>^^^INFO: Installing the server JRE ...</echo>
    <antcall target="install-jre-tar"/>
    <antcall target="install-jre-exe"/>
  </target>

  <target name="load-user-setup-properties" if="setup">
    <echo>^^^DEBUG:
      Checking for existence of install configuration file (${setup})
    </echo>

    <absolutePath property="setup.absolute"
                  path="${setup}"
                  pwd="${install.dir}/.."
                  failOnMissing="false"/>
    <available property="user-setup-properties.available"
               file="${setup.absolute}"/>
  	
    <loadproperties srcFile="${setup.absolute}">
       <filterchain>
         <linecontains negate="true">
           <contains value="server.admin.password"/>
         </linecontains>
       </filterchain>
     </loadproperties>


    <msgfail unless="user-setup-properties.available">^^^ERROR:\
       The specified Hyperic HQ install configuration file does not exist:
         ${setup.absolute}
       Make sure that the setup property is set to the correct file and
       try running the installer again.
    </msgfail>
        
    <findWritable property="newSetup"
                          preferredDir="${install.dir}"
                          filename="data/setup.properties"
                          altDirPrefix="HQ_tmp">^^^INFO:
        WARNING: New setup properties file can't be written to %ORIGINALFILE%
        Setup properties will be written to %WRITABLEFILE% instead.
    </findWritable>
  	
     <delete file="${newSetup}"/>
    <echo>^^^INFO: Loading install configuration...</echo>
    <echo>^^^DEBUG: Loading from ${setup}...</echo>
    <echo>^^^DEBUG: doing non-interactive, accept= ${accept.eula} ...</echo>
   
    <ant antfile="setup-noninteractive.xml" target="generate-props"/>
    <property file="${newSetup}"/>
    <echo>^^^DEBUG: Install configuration loaded.</echo>
  </target>

  <target name="load-default-setup-properties" unless="setup">

    <findWritable property="setup"
                  preferredDir="${install.dir}"
                  filename="data/setup.properties"
                  altDirPrefix="HQ_tmp">^^^INFO:
WARNING: Setup properties file can't be written to %ORIGINALFILE%
Setup properties will be written to %WRITABLEFILE% instead.
    </findWritable>
    <delete file="${setup}"/>
    <ant antfile="setup-interactive.xml" target="generate-props"/>
    <echo>^^^INFO: Loading install configuration...</echo>
    <property file="${setup}"/>
    <absolutePath property="setup.absolute"
                  path="${setup}"
                  failOnMissing="true"/>
    <echo>^^^DEBUG: Install configuration loaded.</echo>
  </target>

  <target name="check-eula">
    <available file="eula.txt" property="eula.present"/>
  </target>

  <target name="show-eula" depends="check-eula" if="eula.present">
    <echo>^^^DEBUG: accepted=${accept.eula}...</echo>
    <antcall target="show-eula-unless-accepted" />
  </target>

  <target name="show-eula-unless-accepted" unless="accept.eula">
      <echo>^^^DEBUG: show-eula...</echo>
        <loadfile property="eula.text" srcFile="eula.txt"/>
        <echo>^^^INFO:
__ll__
${eula.text}
__ll__
        </echo>
    <input message="Do you accept the terms of the agreement?"
           validargs="y,n"
           addproperty="license.accepted" />
        <condition property="do.abort">
      <equals arg1="n" arg2="${license.accepted}"/>
    </condition>
    <fail if="do.abort">The license must be accepted in order to proceed with the installation.</fail>
  </target>

  <target name="init"
          depends="load-basics,check-eula,load-user-setup-properties,show-eula,load-default-setup-properties">

    <!-- Parameterized names of things to deploy -->
    <echo>^^^INFO: Preparing to install...</echo>

    <condition property="script-ext" value=".bat">
      <os family="windows"/>
    </condition>
    <condition property="exe-ext" value=".exe">
      <os family="windows"/>
    </condition>
    <condition property="script-ext" value=".sh">
      <os family="unix"/>
    </condition>
    <condition property="exe-ext" value="">
      <os family="unix"/>
    </condition>

    <condition property="server.dont-check-for-overwrite">
      <equals arg1="${server.overwrite}" arg2="Yes"/>
    </condition>
  </target>

  <target name="validate-any" depends="init">
    <if>
      <and>
        <not><isset property="server.installdir"/></not>
        <not><isset property="hyperic-hq-agent.installdir"/></not>
      </and>
      <then>
        <property name="nothing-to-install" value="true"/>
      </then>
    </if>
    <msgfail if="nothing-to-install">^^^ERROR:
      No software was chosen to install.
    </msgfail>
  </target>

  <target name="all"
          depends="validate-any,agent.valid-props,server.valid-props,agent,server">
    <echo>^^^INFO:
__ll__
Setup completed.
A copy of the output shown above has been saved to:
  ${install.log.path}
__ll__
    </echo>
    <antcall target="pause-before-exit"/>
  </target>

  <!-- If the installer was started by someone double-clicking on the
       setup.bat file, we don't want to make the DOS window just
       disappear on them when the install is done -->
  <target name="pause-before-exit" if="isWin32" unless="server.automatic.installation">
    <if>
      <istrue value="${server.pgsql.available}" />
    	
      <then>
        <input message="Press the Enter key to exit setup."/>
      </then>
    </if>
  </target>

  <target name="agent.valid-props" if="hyperic-hq-agent.installdir">
    <echo>^^^DEBUG: Validating agent install configuration...</echo>
  </target>

  <target name="validate-os-install">
  </target>
    
    <target name="unpack-agent">
        <antcall target="pre-agent-unpack">
              <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}"/>
        </antcall>
      <echo>^^^INFO:
            Unpacking ${agent.bundle} to: ${hyperic-hq-agent.installdir}/agent-${version}...
       </echo>
       <untar src="${agent.bundle}"
               dest="${hyperic-hq-agent.installdir}"
               compression="gzip">
       <globmapper from="hyperic-hq-agent-${version}/*" to="agent-${version}/*"/>
      </untar>
      <property name="agent-command" value="${hyperic-hq-agent.installdir}/agent-${version}/bin/hq-agent.sh"/>
        <antcall target="post-agent-unpack">
            <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}"/>
         </antcall>
    </target>
    
    <target name="unzip-agent">
        <antcall target="pre-agent-unpack">
              <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}"/>
        </antcall>
         <echo>^^^INFO:
                    Unpacking ${agent.bundle} to: ${hyperic-hq-agent.installdir}/agent-${version}...
        </echo>
          <unzip src="${agent.bundle}"
                       dest="${hyperic-hq-agent.installdir}">
            <globmapper from="hyperic-hq-agent-${version}/*" to="agent-${version}/*"/>
          </unzip>
          <antcall target="post-agent-unpack">
                <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}"/>
          </antcall>
    </target>
    
    <target name="unpack-ee-agent">
        <antcall target="pre-agent-unpack">
            <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}-EE"/>
        </antcall>
       <echo>^^^INFO:
            Unpacking ${agent.bundle} to: ${hyperic-hq-agent.installdir}/agent-${version}-EE...
       </echo>
       <untar src="${agent.bundle}"
               dest="${hyperic-hq-agent.installdir}"
               compression="gzip">
       <globmapper from="hyperic-hqee-agent-${version}/*" to="agent-${version}-EE/*"/>
      </untar>
        <antcall target="post-agent-unpack">
            <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}-EE"/>
         </antcall>
    </target>
    
    <target name="unzip-ee-agent">
        <antcall target="pre-agent-unpack">
              <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}-EE"/>
        </antcall>
         <echo>^^^INFO:
                    Unpacking ${agent.bundle} to: ${hyperic-hq-agent.installdir}/agent-${version}-EE...
        </echo>
          <unzip src="${agent.bundle}"
                       dest="${hyperic-hq-agent.installdir}">
            <globmapper from="hyperic-hqee-agent-${version}/*" to="agent-${version}-EE/*"/>
          </unzip>
          <antcall target="post-agent-unpack">
                <param name="agent-dir" value="${hyperic-hq-agent.installdir}/agent-${version}-EE"/>
          </antcall>
    </target>
    
	<target name="check-agent-dir-exists">
	  <echo>^^^DEBUG: Looking for previous installation</echo>
	  <condition property="agentdirexists">
	    <available file="${agent-dir}" type="dir"/>
	  </condition>
	 </target>

	 <target name="pre-agent-unpack" depends="check-agent-dir-exists" if="agentdirexists">	 	
	    <fail>Agent installation directory '${agent-dir}' already exists. Please remove it or supply a different directory name.</fail>
	</target>
	
    <target name="post-agent-unpack">
        <echo>^^^INFO: Setting permissions on ${agent-dir}...</echo>
        <chmod perm="go-rwx" type="both">
            <fileset dir="${agent-dir}">
                <include name="**/bin" />
                <include name="**/conf" />
                <include name="**/log" />
                <include name="**/wrapper" />
            </fileset>
        </chmod>
        <echo>^^^INFO: Setting permissions on ${agent-dir}/conf/agent.properties...</echo>
        <chmod file="${agent-dir}/conf/agent.properties" perm="600"/>
        <echo>^^^INFO: Setting permissions on agent binaries...</echo>
        <antcall target="chmod-exec">
            <param name="chmod.dir" value="${agent-dir}"/>
        </antcall>
  
        <echo>^^^INFO: Fixing line endings on text files...</echo>
        <antcall target="fix-text-files">
            <param name="crlf.dir" value="${agent-dir}"/>
        </antcall>
    </target>

  <target name="agent"
          depends="agent.valid-props,setup-agent-init"
          if="hyperic-hq-agent.installdir"
          description="Install the HQ agent.">
    <echo>^^^INFO: Installing the agent...</echo>
   
    <foreach param="agent.bundle" target="unpack-agent">
        <param name="hyperic-hq-agent.installdir" value="${hyperic-hq-agent.installdir}"/>
        <param name="version" value="${version}"/>
        <path>
            <fileset dir="${base}" includes="hyperic-hq-agent-*.tar.gz"/>
        </path>
    </foreach>
    
    <foreach param="agent.bundle" target="unzip-agent">
            <param name="hyperic-hq-agent.installdir" value="${hyperic-hq-agent.installdir}"/>
            <param name="version" value="${version}"/>
            <path>
                <fileset dir="${base}" includes="hyperic-hq-agent-*.zip"/>
            </path>
     </foreach>

    <foreach param="agent.bundle" target="unpack-ee-agent">
        <param name="hyperic-hq-agent.installdir" value="${hyperic-hq-agent.installdir}"/>
        <param name="version" value="${version}"/>
        <path>
            <fileset dir="${base}" includes="hyperic-hqee-agent-*.tar.gz"/>
        </path>
    </foreach>
    
    <foreach param="agent.bundle" target="unzip-ee-agent">
            <param name="hyperic-hq-agent.installdir" value="${hyperic-hq-agent.installdir}"/>
            <param name="version" value="${version}"/>
            <path>
                <fileset dir="${base}" includes="hyperic-hqee-agent-*.zip"/>
            </path>
     </foreach>
    
    <echo>^^^COMPLETION:
      Agent successfully installed to: ${hyperic-hq-agent.installdir}
    </echo>
   <echo>^^^INFO: 
    You can now start your HQ agent by running this command:

       ${agent.command} start
   </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.agent-summary.txt" prefix="^^^INFO:"/>
  </target>

<target name="setup-agent-init" depends="setup-agent-ee,setup-agent-org,setup-agent-ee-command,setup-agent-command"/>

   <target name="setup-agent-ee" depends="check-eula" if="eula.present">
        <property name="agent.vname" value="agent-${version}-EE"/>
        <property name="agent.product.dir"
              value="${hyperic-hq-agent.installdir}/${agent.vname}"/>
   </target>

   <target name="setup-agent-org" depends="check-eula" unless="eula.present">
        <property name="agent.vname" value="agent-${version}"/>
        <property name="agent.product.dir"
              value="${hyperic-hq-agent.installdir}/${agent.vname}"/>
   </target>

   <target name="setup-agent-ee-command" if="isWin32">
        <property name="agent.command" value="${agent.product.dir}/bin/hq-agent.bat"/>
   </target>

   <target name="setup-agent-command" unless="isWin32">
       <property name="agent.command" value="${agent.product.dir}/bin/hq-agent.sh"/>
   </target>

  <target name="validate-user-privs"
          if="server.database-url"
          unless="using.builtin.db">
    <!-- Do a sanity check - does the user have the perms required on the DB -->
    <echo>^^^DEBUG: Checking database permissions...</echo>
    <dbprivcheck jdbcUrl="${server.database-url}"
                 jdbcUser="${server.database-user}"
                 jdbcPassword="${server.database-password}"
                 encryptionKey="${server.encryption-key}"
                 property="server.db.user.permission"
                 errMsgProperty="errMsg"/>
    <antcall target="fail-if-no-permission">
      <param name="errMsg" value="${errMsg}"/>
    </antcall>
  </target>

  <target name="load-upgrade-conf" if="setup.upgrade">
    <!-- Source the existing consolidated config as properties -->
    <property file="${server.upgradedir}/conf/hq-server.conf"/>
  </target>

  <target name="server.valid-props" depends="load-upgrade-conf" if="server.installdir">
    <echo>^^^DEBUG: Validating server install configuration...</echo>
    <msgfail unless="server.database">^^^ERROR:
      No server.database property specified.
    </msgfail>
    <msgfail unless="server.webapp.port">^^^ERROR:
      No server.webapp.port property specified.
    </msgfail>
    <msgfail unless="server.webapp.secure.port">^^^ERROR:
      No server.webapp.secure.port property specified.
    </msgfail>
    <msgfail unless="server.mail.host">^^^ERROR:
      No server.mail.host property specified.
    </msgfail>
    <if>
      <istrue value="${server.database.create}" />
      <then>
        <msgfail unless="server.webapp.baseurl">^^^ERROR:
          No server.webapp.baseurl property specified.
        </msgfail>
      </then>
    </if>

    <!-- Do a sanity check - is anything listening on the server port now? -->
    <echo>^^^DEBUG: Checking server webapp port...</echo>
    <condition property="server.webapp.port.isAlreadyUsed">
      <socket server="127.0.0.1" port="${server.webapp.port}"/>
    </condition>
    <antcall target="fail-if-webapp-port-used"/>

    <!-- Do a sanity check - is anything listening on the server's secure port now? -->
    <echo>^^^DEBUG: Checking server secure webapp port...</echo>
    <condition property="server.webapp.secure.port.isAlreadyUsed">
      <socket server="127.0.0.1" port="${server.webapp.secure.port}"/>
    </condition>
    <antcall target="fail-if-webapp-secure-port-used"/>

    <!-- Hack to set the builtin flag if hqdb exists in previous install -->
    <available file="${server.upgradedir}/hqdb" property="using.builtin.db"/>

    <!-- Do a sanity check - does the user have the perms required on the DB -->
    <antcall target="validate-user-privs" />

    <if>
      <istrue value="${server.database.create}" />
      <then>
        <echo>^^^DEBUG: Verifying admin user properties</echo>
        <msgfail unless="server.admin.username">^^^ERROR:\
          No server.admin.username property was specified.
        </msgfail>
        <msgfail unless="server.admin.password">^^^ERROR:\
          No server.admin.password property was specified.
        </msgfail>
        <msgfail unless="server.admin.email">^^^ERROR:\
          No server.admin.email property was specified.
        </msgfail>

        <condition property="server.admin.username.illegal">
          <equals arg1="${server.admin.username}" arg2="admin" trim="true"/>
        </condition>
        <msgfail if="server.admin.username.illegal">^^^ERROR:\
          The server.admin.username property has an illegal or reserved value.
        </msgfail>
      </then>
    </if>

    <!-- Do DB-specific validation stuff -->
    <echo>^^^DEBUG: Validating server DB configuration...</echo>
    <ant antfile="setup-db-${server.database}.xml"
         target="validate"/>
  </target>

  <target name="fail-if-webapp-port-used" if="server.webapp.port.isAlreadyUsed">
    <msgfail>^^^ERROR:\
      There is another program using port ${server.webapp.port}.
      Please choose a different value for the server.webapp.port property.
        
      Run the setup program with the "-full" option so that you
      can pick either an alternate port or a different database to use
      for the HQ server.
    </msgfail>
  </target>
  <target name="fail-if-webapp-secure-port-used" if="server.webapp.secure.port.isAlreadyUsed">
    <msgfail>^^^ERROR:\
      There is another program using port ${server.webapp.secure.port}.
      Please choose a different value for the server.webapp.secure.port property.
        
      Run the setup program with the "-full" option so that you
      can pick either an alternate port or a different database to use
      for the HQ server.
    </msgfail>
  </target>
  <target name="fail-if-no-permission" unless="server.db.user.permission">
    <msgfail>^^^ERROR:\
${errMsg}
    </msgfail>
  </target>

  <target name="server"
          depends="validate-os-install,server.valid-props,setup-server-init,fail-if--server.alreadyInstalled"
          if="server.installdir"
          description="Install or upgrade the HQ server.">
    <antcall target="server-install"/>
    <antcall target="server-upgrade"/>
     <antcall target="copy-oss-license-file">
            <param name="oss.license.to.dir" value="${server.product.dir}"/>
     </antcall>
  </target>

  <target name="server-install" unless="setup.upgrade">
    <echo>^^^INFO: Installing the server...</echo>
    <antcall target="setup-server"/>
    <echo>^^^COMPLETION:
      Server successfully installed to: ${server.product.dir}
    </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.server-summary.txt" prefix="^^^INFO:"/>
  </target>

  <target name="server-upgrade" if="setup.upgrade">
    <echo>^^^INFO: Upgrading the server...</echo>
    <antcall target="setup-server"/>
    <echo>^^^INFO: Copying existing hq-server.conf</echo>
    <!-- Backup conf file to maintain comments -->
    <tstamp>
        <format property="current.time" pattern="yyyy-MM-dd.hhmm"/>
    </tstamp>

    <!-- Copy the existing config -->
  	<if> 
  		<not> 
  		  <isset property="migration.context" />
  		</not> 
	 	<then> 
	 		<copy file="${server.upgradedir}/conf/hq-server.conf"
	 		                tofile="${server.product.dir}/conf/hq-server-${current.time}.conf"
	 		                failonerror="false"/>
	 		
	 	    <serverConfigUpgrade existing="${server.upgradedir}/conf/hq-server.conf" 
	 	        new="${server.product.dir}/conf/hq-server.conf" upgradeDir="${server.upgradedir}"/>
	 	</then> 
	 	<else>
	 		<copy file="${server.product.dir}/conf/hq-server.conf"
	 		                tofile="${server.product.dir}/conf/hq-server-${current.time}.conf"
	 		                failonerror="false"/>
	 		
	 		<properties-merge baseFile="${server.upgradedir}/conf/hq-server.conf" overrideFile="${server.product.dir}/conf/hq-server.conf" outputFile="${server.product.dir}/conf/hq-server.conf">  
		  		<propertiesMergeFilter refid="${hq-server.conf.filter.refid}" />
		    </properties-merge> 
	 	</else> 
    </if>
    
    <!-- Copy the existing license file, if there is one -->
    <!-- Disable copying of license.xml file for 4.6 upgrade bc it's now different, post 4.6 upgrades should
         copying the serial file, if one exists...
    <echo>^^^INFO: Copying existing license file</echo>
    <copy file="${server.upgradedir}/conf/license.xml"
          todir="${server.product.dir}/conf"
          failonerror="false"/>
    -->
    
    <echo>^^^INFO: Copying keystore</echo>
    <available file="${server.upgradedir}/conf/hyperic.keystore" property="keystore.exists"/>
    <antcall target="copy-keystore-upgrade" />
    
    <!-- Copy log4j.xml from evolution or later -->
    <copy file="${server.upgradedir}/conf/log4j.xml"
            todir="${server.product.dir}/conf"
            failonerror="false"/>
    
    <echo>^^^INFO: Copying existing HQ server cache information</echo>
    <!-- Copy from 4.4 or earlier -->
    <ehcacheUpgrade existing="${server.upgradedir}/hq-engine/server/default/deploy/hq.ear/ehcache.xml"
                    new="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/classes/ehcache.xml"/>

    <!-- Copy from evolution or later -->
    <ehcacheUpgrade existing="${server.upgradedir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/classes/ehcache.xml"
                        new="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/classes/ehcache.xml"/>
    
  	<echo>^^^INFO: Copying existing community plugins (removed from default package in 5.8)</echo>
    <copy todir="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/hq-plugins" failonerror="false">
      <fileset dir="${server.upgradedir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/hq-plugins" 
      	includes="alfresco-plugin.jar,glassfish-plugin.xml,iplanet-plugin.jar,nagios-plugin.jar,postfix-plugin.jar,vsphere-plugin.jar,
      	coldfusion-plugin.jar,jetty-plugin.xml,netapp-plugin.jar,vim-plugin.jar,zimbra-plugin.jar,
      	geronimo-plugin.xml,informix-plugin.jar,memcached-plugin.jar,perlbal-plugin.jar,vmware-plugin.jar"/>
    </copy>
  	
  	<echo>^^^INFO: Copying existing HQU plugins</echo>
    <!-- Copy from 4.4 or earlier-->
    <uiPluginUpgrade newHquDir="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/hqu" 
        existingHquDir="${server.upgradedir}/hq-engine/server/default/deploy/hq.ear/hq.war/hqu"/>
    
    <!--Copy from evolution or later -->
    <uiPluginUpgrade newHquDir="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/hqu" 
          existingHquDir="${server.upgradedir}/hq-engine/hq-server/webapps/ROOT/hqu"/>
    
    <echo>^^^INFO: Copying existing state files</echo>
    <!-- Copy from 4.4 or earlier-->
    <copy todir="${server.product.dir}/hq-engine/hq-server" failonerror="false">
      <fileset dir="${server.upgradedir}/hq-engine" includes="*.dat"/>
    </copy>
    
    <!--Copy from evolution or later -->
    <copy todir="${server.product.dir}/hq-engine/hq-server" failonerror="false">
      <fileset dir="${server.upgradedir}/hq-engine/hq-server" includes="*.dat"/>
    </copy> 

    <echo>^^^INFO: Copying unprocessed metric data files</echo>
    <!-- Copy from 4.4 or earlier-->
    <copy todir="${server.product.dir}/hq-engine/hq-server" failonerror="false">
      <fileset dir="${server.upgradedir}/hq-engine" includes="*Inserter.tmp"/>
    </copy>
    
    <!--Copy from evolution or later -->
    <copy todir="${server.product.dir}/hq-engine/hq-server" failonerror="false">
      <fileset dir="${server.upgradedir}/hq-engine/hq-server" includes="*Inserter.tmp"/>
    </copy>
  
    <echo>^^^COMPLETION:
      Server successfully upgraded to: ${server.product.dir}
    </echo>
    <concatWithPrefix failOnMissing="false" file="${setup}.server-summary.txt" prefix="^^^INFO:"/>
  </target>

  <target name="setup-server-init" depends="setup-server-ee,setup-server-org"/>


   <target name="setup-server-ee" depends="check-eula" if="eula.present">
        <property name="server.vname" value="server-${version}-EE"/>
        <property name="server.product.dir"
              value="${server.installdir}/${server.vname}"/>
   </target>

 <target name="setup-server-org" depends="check-eula" unless="eula.present">
        <property name="server.vname" value="server-${version}"/>
        <property name="server.product.dir"
              value="${server.installdir}/${server.vname}"/>
   </target>
	


    <target name="update-hq-server-profile" depends="load-basics, check-eula">
       <fail unless="eula.present" message="Updating scale is only available in the EE version"/>        
        <condition property="profile.notValid">
            <and>               
                <not>
                     <equals arg1="${install.profile}" arg2="small"/>
                    </not>
                <not>
                     <equals arg1="${install.profile}" arg2="medium"/>
                    </not>
                <not>
                     <equals arg1="${install.profile}" arg2="large"/>
                    </not>
            </and>
        </condition>
        <fail if="profile.notValid" message="Not a valid profile must be small/medium/large"/>
        <antcall target="load-properties"/>
        <updateServerProfile src="${server.product.dir}/conf/hq-profiles.properties"
                                    dest="${server.product.dir}/conf/hq-server.conf"/>
         <delete file="${server.product.dir}/conf/hq-profiles.properties"/> 
         <echo>^^^DEBUG: The server is now updated to "${install.profile}" profile...</echo>
    </target>
	
    <target name="install-hq-server-profile">
        <property name="install.profile" value="small"/>
        <echo>^^^DEBUG: Using "${install.profile}" installing profile...</echo>
        
        <antcall target="load-properties"/>
        <antcall target="load-properties-to-conf-file"/>
        <antcall target="load-properties-to-web-xml-file"/>
    <!--After the properties has been loaded, we can delete the file-->
    <delete file="${server.product.dir}/conf/hq-profiles.properties"/> 
    </target>

    
    <target name="load-properties-to-web-xml-file">
         <echo>^^^DETAILED: Loading properties into web.xml</echo>
    	  <loadproperties srcFile="${server.product.dir}/conf/hq-profiles.properties"/>
    	  <webContextConfigure webContextFile="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/web.xml"
    	  	maxConns="${max.conns}"/>           
    </target>
    
    <target name="load-properties-to-conf-file"  unless="setup.upgrade">
        <echo>^^^DETAILED: Loading properties into hq-server.conf</echo>
        <loadproperties srcFile="${server.product.dir}/conf/hq-profiles.properties"/>             
        <substProps src="${install.dir}/data/hq-server.conf"
                            dest="${conf-dir}/hq-server.conf"/>
                <replace file="${conf-dir}/hq-server.conf" token="@SERVER_CONF@" value="${conf-dir}" />
    </target>
        
    <target name="load-properties">
        <echo>^^^DETAILED: Loading properties according to the selected installation profile</echo>
                <copy tofile="${server.product.dir}/conf/hq-profiles.properties"
                                      file="${install.dir}/data/hq-profiles.properties"
                                      overwrite="true"/>
                <replaceregexp file="${server.product.dir}/conf/hq-profiles.properties"
                       match="(.${install.profile})"
                       replace=""
                       byline="true"/>
      </target>
    
    <target name="unpack-server">
        <echo> 
              ^^^INFO: Unpacking server to: ${server.installdir}...
        </echo>
        <untar src="${server.bundle}"
                   dest="${server.installdir}"
                   compression="gzip"/>
  </target>

  <target name="setup-server" unless="migration.context">
    <!-- The server distro will unzip to a server-${version} dir, but the tar.gz may have build stamp in name -->
    <foreach param="server.bundle" target="unpack-server">
        <param name="server.installdir" value="${server.installdir}"/>
        <param name="version" value="${version}"/>
        <path>
            <fileset dir="${base}" includes="server-*.tar.gz"/>
        </path>
     </foreach>

    <!-- Setup conf directory -->
    <echo>^^^INFO: Creating server configuration files...</echo>
    <property name="conf-dir" value="${server.product.dir}/conf"/>
    <antcall target="copy-license"/>
  	<antcall target="update-jars"/>
    <antcall target="copy-keystore" />
    <antcall target="install-hq-server-profile"/>
    <property name="tomcat.home"
              value="${server.product.dir}/hq-engine"/>
    <echo>^^^INFO: Copying binaries and libraries to server installation...</echo>

    <!-- We only keep this file around for debugging, in case we need
         to know what settings the user used when they originally
         installed the server -->
    <echo>^^^DEBUG: Copying server configuration file...</echo>
    <copy tofile="${server.product.dir}/data/hq-server-install.conf"
          file="${setup.absolute}">
     <filterchain>
      <linecontains negate="true">
        <contains value="server.admin.password"/>
      </linecontains>
     </filterchain>
    </copy>

    <chmod file="${server.product.dir}/data/hq-server-install.conf" perm="go-rwx"/>

    <!-- Copy server control file to server's data dir -->
    <mkdir dir="${server.product.dir}/data"/>

    <echo>^^^DEBUG: Copying server db-upgrade files...</echo>
    <copy todir="${server.product.dir}/data">
      <fileset dir="${install.dir}/data">
        <include name="db-upgrade.xml"/>
        <include name="common-dbsetup-typemap.xml"/>
      </fileset>
    </copy>

    <!-- Copy lib jars to server's lib dir -->
    <echo>^^^DEBUG: Copying server libs...</echo>
    <mkdir dir="${server.product.dir}/lib"/>
    <copy todir="${server.product.dir}/lib">
      <fileset dir="${install.dir}/lib">
        <include name="ant-contrib.jar"/>
        <include name="ant.jar"/>
        <include name="ant-launcher.jar"/>
        <include name="commons-logging-1.0.4.jar"/>
        <include name="hq-installer.jar"/>
        <include name="hq-util.jar"/>
        <include name="hq-common.jar"/>
        <include name="oro-2.0.8.jar"/>
        <include name="sigar-*.dll"/>
        <include name="libsigar-*"/>
        <include name="libreadline-java.jar"/>
        <include name="optional.jar"/>
        <include name="sigar.jar"/>
        <include name="xercesImpl.jar"/>
        <include name="xml-apis.jar"/>
        <include name="groovy-all-*.jar"/>
        <include name="hibernate3.jar"/>
        <include name="postgresql-*.jar"/>
        <include name="mysql-connector-java-*.jar"/>
        <include name="ojdbc*.jar"/>
      </fileset>
    </copy>

    <!-- Do DB-specific stuff -->
    <echo>^^^INFO: Setting up server database...</echo>
    <ant antfile="setup-db-${server.database}.xml" target="setup"/>
    
    <antcall target="install-server-jre">
      <param name="destination" value="${server.product.dir}" />
    </antcall>

    <!-- Mark executables as executable -->
    <echo>^^^INFO: Setting permissions on ${server.product.dir}...</echo>

    <!-- Must break things up into chunks to avoid overly-long argument lists.  The webapps, in the hq-server
         hierarchy, are the directories with the most files, so narrow down to them -->
    <chmod perm="go-rwx" type="both">
        <fileset dir="${server.product.dir}">
            <exclude name="hq-engine/**" />
            <exclude name="jre/**" />
            <exclude name="hqdb/**" />
        </fileset>
    </chmod>    

    <chmod perm="go-rwx" type="both">
        <fileset dir="${server.product.dir}/hq-engine">
            <exclude name="hq-server/**" />
        </fileset>
    </chmod>    

    <chmod perm="go-rwx" type="both">
        <fileset dir="${server.product.dir}/hq-engine/hq-server">
            <exclude name="webapps/**" />
            <exclude name="work/**" />
        </fileset>
    </chmod>    

    <chmod perm="go-rwx" type="both">
        <fileset dir="${server.product.dir}/hq-engine/hq-server/webapps">
            <exclude name="ROOT/**" />
        </fileset>
    </chmod>    

    <chmod perm="go-rwx" type="both">
        <fileset dir="${server.product.dir}/hq-engine/hq-server/webapps">
            <include name="ROOT" /> 
        </fileset>
    </chmod>    

    <!-- Don't traverse recursively into the ROOT webapp, it's enough to restrict permissions on the top-level directories -->
    <chmod perm="go-rwx" type="both">
        <fileset dir="${server.product.dir}/hq-engine/hq-server/webapps/ROOT">
            <include name="*" />
        </fileset>
    </chmod>

    <echo>^^^INFO: Setting permissions on server binaries...</echo>
    <antcall target="chmod-exec">
      <param name="chmod.dir" value="${server.product.dir}"/>
    </antcall>
    <echo>^^^INFO: Fixing line endings on text files...</echo>
    <antcall target="fix-text-files">
      <param name="crlf.dir" value="${server.product.dir}"/>
    </antcall>

    <delete dir="${server.product.dir}/data/conf"/>

    <antcall target="debug-setup"/>
  </target>
     
	<target name="copy-license" unless="setup.upgrade">
        <copy file="${install.dir}/data/license.xml" todir="${conf-dir}"
              failonerror="false"/>
      </target>

      <target name="copy-keystore" unless="setup.upgrade">
        <copy file="${install.dir}/data/hyperic.keystore" 
            tofile="${server.product.dir}/conf/hyperic.keystore"
              failonerror="false"/>
        <copy file="${install.dir}/data/hyperic.keystore" 
            tofile="${server.product.dir}/conf/hyperic.keystore.backup.DO.NOT.DELETE"
                      failonerror="false"/>
        <delete file="${install.dir}/data/hyperic.keystore" />
      </target>

      <target name="copy-keystore-upgrade">
        <antcall target="copy-generated-keystore" />
        <antcall target="copy-existing-keystore" />
      </target>
    
      <target name="copy-generated-keystore" unless="keystore.exists">
        <copy file="${install.dir}/data/hyperic.keystore" 
            tofile="${server.product.dir}/conf/hyperic.keystore"
            failonerror="false"/>
        <copy file="${install.dir}/data/hyperic.keystore" 
            tofile="${server.product.dir}/conf/hyperic.keystore.backup.DO.NOT.DELETE"
                      failonerror="false"/>
        <delete file="${install.dir}/data/hyperic.keystore" />
      </target>
    
      <target name="copy-existing-keystore" if="keystore.exists">
        <copy file="${server.upgradedir}/conf/hyperic.keystore"
                    tofile="${server.product.dir}/conf/hyperic.keystore"
                    failonerror="false"/>
        <copy file="${server.upgradedir}/conf/hyperic.keystore.backup.DO.NOT.DELETE"
                    tofile="${server.product.dir}/conf/hyperic.keystore.backup.DO.NOT.DELETE"
                    failonerror="false"/>
      </target>
    
  <!-- If server.overwrite is not set or is false, check for an
       existing HQ server installation -->
  <target name="fail-if--server.alreadyInstalled"
          if="server.installdir"
          unless="server.dont-check-for-overwrite">
    <condition property="server.isInstalled">
      <or>
        <available file="${server.product.dir}"/>
        <available file="${server.installdir}/conf/hq-server.conf"/>
      </or>
    </condition>
    <msgfail if="server.isInstalled">^^^ERROR:\
      The installer detected that a Hyperic HQ server is already
      installed in ${server.product.dir}
    </msgfail>
  </target>

  <!-- Only fix line endings on windows.  Line endings will not contain CR's
       so there should be no reason to run this on unix platforms.  This
       task is also broken on Darwin with Ant 1.5 -->
  <target name="fix-text-files" if="isWin32">
    <fixcrlf srcdir="${crlf.dir}"
        includes="**/*.bat **/*.properties **/*.txt **/ReadMe* **/*.conf **/*.xml"/>
  </target>
    
  <!--- Copy the license file for the open source software to a designated directory -->
  <target name="copy-oss-license-file">
     <copy file="${oss.license.file}" todir="${oss.license.to.dir}" failonerror="false"/>
     <copy file="${oss.gpl.license.file}" todir="${oss.license.to.dir}" failonerror="false"/>
     <copy file="${oss.ee.license.file}" todir="${oss.license.to.dir}" failonerror="false"/>
  </target>
	
 <target name="update-jars">
	<move file="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/lib/${vfabric.license.jar.name}"
	tofile="${server.product.dir}/hq-engine/hq-server/webapps/ROOT/WEB-INF/lib/zvfabric-client-parent.jar"
	failonerror="false" />
 </target>


  <target name="chmod-exec">
    <chmod perm="750">
      <fileset dir="${chmod.dir}">
        <include name="**/bin/*"/>
        <include name="**/sbin/*"/>
        <!-- Set java permissions for Sun Sparc 64 bit JVM -->
        <include name="**/bin/sparcv9/*"/>
        <include name="**/*.sh"/>
        <include name="**/*.bat"/>
        <include name="**/*.cmd"/>
        <include name="**/*.sl"/>
      </fileset>
    </chmod>
  </target>

  <target name="debug-check">
    <condition property="debug.enabled">
      <available file="${install.dir}/data/debug"/>
    </condition>
  </target>
  <target name="debug-setup" depends="debug-check" if="debug.enabled">
    <echo>^^^INFO: Setting up debugging code...</echo>
    <ant antfile="${install.dir}/data/debug/install-build.xml"
         target="install">
      <property name="debug.home" value="${install.dir}/data/debug"/>
      <property name="tomcat.home" value="${tomcat.home}"/>
    </ant>
  </target>
</project>

<?xml version="1.0"?>

<!DOCTYPE plugin [
  <!ENTITY hibernate-plugin SYSTEM "/etc/hibernate-plugin.xml">
]>

<!--
  NOTE: This copyright does *not* cover user programs that use HQ
  program services by normal system calls through the application
  program interfaces provided as part of the Hyperic Plug-in Development
  Kit or the Hyperic Client Development Kit - this is merely considered
  normal use of the program, and does *not* fall under the heading of
  "derived work".
  
  Copyright (C) [2004, 2005, 2006], Hyperic, Inc.
  This file is part of HQ.
  
  HQ is free software; you can redistribute it and/or modify
  it under the terms version 2 of the GNU General Public License as
  published by the Free Software Foundation. This program is distributed
  in the hope that it will be useful, but WITHOUT ANY WARRANTY; without
  even the implied warranty of MERCHANTABILITY or FITNESS FOR A
  PARTICULAR PURPOSE. See the GNU General Public License for more
  details.
  
  You should have received a copy of the GNU General Public License
  along with this program; if not, write to the Free Software
  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307
  USA.
 -->

<plugin name="jboss" class="JBossProductPlugin">

  <classpath>
    <include name="client/jnp-client.jar"/>
    <include name="client/jboss-common-client.jar"/>
    <include name="client/jboss-jsr77-client.jar"/>
    <include name="client/jbossall-client.jar"/>
    <include name="client/log4j.jar"/>
    <include name="client/jmx-rmi-connector-client.jar"/>
    <include name="lib/jboss-system.jar"/>
    <include name="lib/jboss-jmx.jar"/>
    <include name="lib/jboss-management.jar"/>
    <include name="lib/dom4j.jar"/>
    <!-- used underneath javax.management.Query.match() -->
    <include name="lib/gnu-regexp.jar"/>
    <!-- required for MainDeployer.listDeployed() -->
    <include name="lib/endorsed/xercesImpl.jar"/>
    <include name="lib/endorsed/xml-apis.jar"/>

    <include name="server/default/lib/jboss-management.jar"/>
    <include name="server/all/lib/jboss-management.jar"/>
    <!-- for jndi authentication -->
    <include name="server/default/lib/jbosssx.jar"/>
    <include name="server/all/lib/jbosssx.jar"/>

    <!-- relative to $installpath incase
         server/{default,all} do not exist -->
    <include name="lib/jboss-management.jar"/>
    <include name="lib/jbosssx.jar"/>
  </classpath>

  <filter name="url" value="java.naming.provider.url"/>

  <filter name="user" value="java.naming.security.principal"/>

  <filter name="pass" value="java.naming.security.credentials"/>

  <!-- appended to each template by MeasurementInfoXML -->
  <property name="template-config"
            value="${url}=%${url}%,${user}=%${user}%,${pass}=%${pass}%"/>

  <filter name="TxManager"
	  value="jboss:service=TransactionManager"/>

  <filter name="JMSMessageCache"
	  value="jboss.mq:service=MessageCache"/>

  <filter name="EJB"
          value="jboss.management.local:name=%ejb.name%,J2EEServer=Local,J2EEApplication=%j2ee.application%,EJBModule=%ejb.jar%"/>

  <filter name="EJBService"
           value="jboss.j2ee:jndiName=%ejb.name%,service=EJB"/>

  <filter name="EJBPool" value="${EJBService},plugin=pool"/>
  			
  <filter name="EJBCache" value="${EJBService},plugin=cache"/>

  <!-- ObjectName properties used in the control plugins -->

  <property name="JCAConnectionPool"
	    value="jboss.jca:service=ManagedConnectionPool,name=%jca.connpool%"/>

  <metrics name="JBoss 3.2">
    <metric name="Availability"
            alias="Availability"
            template="jboss.system:service=MainDeployer:StateString"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>

     <!-- ServerInfo metrics -->
    <metric name="Active Thread Count"
            alias="ActiveThreadCount"
            template="jboss.system:type=ServerInfo:${alias}"
            category="THROUGHPUT"
            indicator="true"
            units="none"
            collectionType="dynamic"/>

    <metric name="Active Thread Group Count"
            alias="ActiveThreadGroupCount"
            template="jboss.system:type=ServerInfo:${alias}"
            category="THROUGHPUT"
            units="none"
            collectionType="dynamic"/>

    <metric name="JVM Free Memory"
            alias="FreeMemory"
            template="jboss.system:type=ServerInfo:${alias}"
            category="UTILIZATION"
            units="B"
            collectionType="dynamic"/>

    <metric name="JVM Total Memory"
            alias="TotalMemory"
            template="jboss.system:type=ServerInfo:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="B"
            collectionType="dynamic"/>

    <metric name="JVM Max Memory"
            alias="MaxMemory"
            template="jboss.system:type=ServerInfo:${alias}"
            category="UTILIZATION"
            units="B"
            collectionType="static"/>

    <!-- transaction manager -->
    <metric name="Transactions Active"
            alias="TxCount"
            template="${TxManager}:TransactionCount"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Transactions Committed"
            alias="TxCommits"
            template="${TxManager}:CommitCount"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Transactions Rolledback"
            alias="TxRollbacks"
            template="${TxManager}:RollbackCount"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="JMS Message Cache Size"
            alias="TotalCacheSize"
            template="${JMSMessageCache}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="JMS Message Cache Hits"
            alias="CacheHits"
            template="${JMSMessageCache}:${alias}"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>

    <metric name="JMS Message Cache Misses"
            alias="CacheMisses"
            template="${JMSMessageCache}:${alias}"
            category="THROUGHPUT"
            units="none"
            collectionType="trendsup"/>

    <metric name="JMS Message Cache Current Memory Usage"
            alias="CurrentMemoryUsage"
            template="${JMSMessageCache}:${alias}"
            category="UTILIZATION"
            units="B"
            collectionType="dynamic"/>

    <metric name="JMS Message Cache High Memory Mark"
            alias="HighMemoryMark"
            template="${JMSMessageCache}:${alias}"
            category="UTILIZATION"
            units="B"
            collectionType="static"/>

    <metric name="JMS Message Cache Max Memory Mark"
            alias="MaxMemoryMark"
            template="${JMSMessageCache}:${alias}"
            category="UTILIZATION"
            units="B"
            collectionType="static"/>
  </metrics>

  <metrics name="JBoss 3.2 JCA Connection Pool">
    <metric name="Min Connections"
            alias="MinSize"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="static"/>

    <metric name="Max Connections"
            alias="MaxSize"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="static"/>

    <metric name="Total Connections"
            alias="ConnectionCount"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Available Connections"
            alias="AvailableConnectionCount"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="dynamic"/>

    <metric name="Active Connections"
            alias="InUseConnectionCount"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="dynamic"/>

    <metric name="Connections Created"
            alias="ConnectionCreatedCount"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Connections Destroyed"
            alias="ConnectionDestroyedCount"
            template="${JCAConnectionPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Availability"
            alias="Availability"
            template="${JCAConnectionPool}:StateString"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
  </metrics>

  <metrics name="JBoss 3.2 Stateless Session EJB">
    <metric name="Create Calls"
            alias="StatisticCreateCount"
            template="${EJB},j2eeType=StatelessSessionBean:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="trendsup"/>

    <metric name="Remove Calls"
            alias="StatisticRemoveCount"
            template="${EJB},j2eeType=StatelessSessionBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Method-Ready Beans"
            alias="StatisticMethodReadyCount"
            template="${EJB},j2eeType=StatelessSessionBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="PoolSize"
            alias="CurrentSize"
            template="${EJBPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="MaxPoolSize"
            alias="MaxSize"
            template="${EJBPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Availability"
            alias="Availability"
            template="${EJB},j2eeType=StatelessSessionBean:StateManageable"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
  </metrics>

  <metrics name="JBoss 3.2 Stateful Session EJB">
    <metric name="Create Calls"
            alias="StatisticCreateCount"
            template="${EJB},j2eeType=StatefulSessionBean:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="dynamic"/>

    <metric name="Remove Calls"
            alias="StatisticRemoveCount"
            template="${EJB},j2eeType=StatefulSessionBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Method-Ready Beans"
            alias="StatisticMethodReadyCount"
            template="${EJB},j2eeType=StatefulSessionBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Passive Beans"
            alias="StatisticPassiveCount"
            template="${EJB},j2eeType=StatefulSessionBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Availability"
            alias="Availability"
            template="${EJB},j2eeType=StatefulSessionBean:StateManageable"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
  </metrics>

  <metrics name="JBoss 3.2 Entity EJB">
    <metric name="Create Calls"
            alias="StatisticCreateCount"
            template="${EJB},j2eeType=EntityBean:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="trendsup"/>

    <metric name="Remove Calls"
            alias="StatisticRemoveCount"
            template="${EJB},j2eeType=EntityBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Ready Beans"
            alias="StatisticReadyCount"
            template="${EJB},j2eeType=EntityBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Pooled Beans"
            alias="StatisticPooledCount"
            template="${EJB},j2eeType=EntityBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="CacheSize"
            alias="CacheSize"
            template="${EJBCache}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="PassivatedCount"
            alias="PassivatedCount"
            template="${EJBCache}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="PoolSize"
            alias="CurrentSize"
            template="${EJBPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="MaxPoolSize"
            alias="MaxSize"
            template="${EJBPool}:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="dynamic"/>

    <metric name="Availability"
            alias="Availability"
            template="${EJB},j2eeType=EntityBean:StateManageable"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
  </metrics>

  <metrics name="JBoss 3.2 Message Driven EJB">
    <metric name="Create Calls"
            alias="StatisticCreateCount"
            template="${EJB},j2eeType=MessageDrivenBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Remove Calls"
            alias="StatisticRemoveCount"
            template="${EJB},j2eeType=MessageDrivenBean:${alias}"
            category="UTILIZATION"
            units="none"
            collectionType="trendsup"/>

    <metric name="Messages Received"
            alias="StatisticMessageCount"
            template="${EJB},j2eeType=MessageDrivenBean:${alias}"
            category="UTILIZATION"
            indicator="true"
            units="none"
            collectionType="trendsup"/>

    <metric name="Availability"
            alias="Availability"
            template="${EJB},j2eeType=MessageDrivenBean:StateManageable"
            category="AVAILABILITY"
            indicator="true"
            units="percentage"
            collectionType="dynamic"/>
  </metrics>

  <!-- note that the templates are not exactly the same.
       jboss 4.0 changed the case of some attribute names,
       the JBoss4MeasurementPlugin.translate method makes the
       adjustments.  -->
  <metrics name="JBoss 4.0" include="JBoss 3.2"/>

  <metrics name="JBoss 4.0 JCA Connection Pool"
           include="JBoss 3.2 JCA Connection Pool"/>

  <metrics name="JBoss 4.0 Stateless Session EJB"
           include="JBoss 3.2 Stateless Session EJB"/>

  <metrics name="JBoss 4.0 Stateful Session EJB"
           include="JBoss 3.2 Stateful Session EJB"/>

  <metrics name="JBoss 4.0 Entity EJB"
           include="JBoss 3.2 Entity EJB"/>

  <metrics name="JBoss 4.0 Message Driven EJB"
           include="JBoss 3.2 Message Driven EJB"/>

  <metrics name="jchannel">
    <metric name="Availability"
            template="${JCHANNEL_OBJECT_NAME}:Connected"
            indicator="true"/>

    <metric name="Number of Messages"
            template="${JCHANNEL_OBJECT_NAME}:NumMessages"
            category="THROUGHPUT"
            indicator="true"
            collectionType="trendsup"/>

    <metric name="Sent Messages"
            template="${JCHANNEL_OBJECT_NAME}:SentMessages"
            category="THROUGHPUT"
            indicator="true"
            collectionType="trendsup"/>

    <metric name="Sent Bytes"
            template="${JCHANNEL_OBJECT_NAME}:SentBytes"
            category="THROUGHPUT"
            indicator="true"
            units="B"
            collectionType="trendsup"/>

    <metric name="Received Bytes"
            template="${JCHANNEL_OBJECT_NAME}:ReceivedBytes"
            category="THROUGHPUT"
            indicator="true"
            units="B"
            collectionType="trendsup"/>
  </metrics>

  <filter name="JCHANNEL_OBJECT_NAME"
          value="JGroups:channel=%channel%"/>

  <metrics name="JBoss 4.0 JGroups Channel" include="jchannel"/>

  <filter name="JCHANNEL_OBJECT_NAME"
          value="jboss.jgroups:type=channel,cluster=%cluster%"/>

  <metrics name="JBoss 4.2 JGroups Channel" include="jchannel"/>

  <help name="header">
  <![CDATA[
    <p>
    <b>jboss.installpath</b> must be configured in agent.properties,
    for example:
    </p>
    <pre>   jboss.installpath=]]>
  </help>

  <help name="footer">
  <![CDATA[
    </pre>
  ]]>
  </help>

  <config name="EJB">
    <option name="ejb.name"
            description="EJB Name"
            default=""/>
    <option name="ejb.jar"
            description="EJB Module (JAR)"
            default=""/>
    <option name="j2ee.application"
            description="J2EE Application"
            default=""/>
  </config>

  <server name="JBoss"
          version="3.2"
          description="Application Server"
          platforms="Unix,Win32">

    <config>
      <option name="${url}"
              description="Naming Provider URL"
              default="jnp://localhost:1099"/>
      <option name="${user}"
              optional="true"
              description="Username"/>
      <option name="${pass}"
              type="secret"
              optional="true"
              description="Password"/>
    </config>

    <config type="control">
      <option name="start.args"
              description="Server start program arguments"
              optional="true"/>
      <option name="stop.program"
              description="Server stop program (default uses JMX)"
              optional="true"/>
      <option name="stop.args"
              description="Server stop program arguments"
              optional="true"
              default="-S"/>
      <option name="configSet"
              description="Server config file set"
              optional="true"
              default="default"/>
    </config>

    <properties>
       <property name="version"
                 description="JBoss Version"/>
       <property name="JavaVersion"
                 description="Java Version"/>
       <property name="JavaVendor"
                 description="Java Vendor"/>
       <property name="BuildDate"
                 description="Build Date"/>
       <property name="VersionName"
                 description="Version Name"/>
    </properties>

    <plugin type="measurement"
            class="JBossMeasurementPlugin"/>

    <plugin type="autoinventory"
            class="JBossDetector"/>

    <plugin type="control"
            class="JBossServerControlPlugin"/>

    <!-- default control plugin impl for services -->
    <property name="SERVICE_CONTROL_PLUGIN"
              value="${package}.JBossServiceControlPlugin"/>

    <property name="DEFAULT_LOG_FILE"
              value="log/server.log"/>

    <plugin type="log_track"
            class="org.hyperic.hq.product.Log4JLogTrackPlugin"/>

    <property name="DEFAULT_CONFIG_FILE"
              value="conf/jboss-service.xml,conf/server.policy"/>

    <plugin type="config_track"
            class="org.hyperic.hq.product.ConfigFileTrackPlugin"/>

    <actions include="stop,start,restart,runGarbageCollector"/>

    <scan>
      <include name="/**/server/*/conf/jboss-service.xml"/>
    </scan>

    &hibernate-plugin;

    <service name="JGroups Channel">
      <property name="OBJECT_NAME"
                value="JGroups:channel=%channel%"/>

      <plugin type="autoinventory"/>

      <config>
        <option name="channel"
                description="Channel Name"
                default=""/>
      </config>
    </service>

    <service name="Stateless Session EJB">
      <config include="EJB"/>
    </service>

    <service name="Stateful Session EJB">
      <config include="EJB"/>
    </service>

    <service name="Entity EJB">
      <config include="EJB"/>
    </service>

    <service name="Message Driven EJB">
      <config include="EJB"/>
    </service>

    <service name="JMS Destination" internal="true">
      <config>
        <option name="name"
                description="JMS Destination"
                default=""/>
      </config>

      <property name="OBJECT_NAME"
                value="jboss.mq.destination:service=Queue,name=%name%"/>

      <plugin type="autoinventory"/>

      <plugin type="control"
              class="JBossStateServiceControlPlugin"/>

      <actions include="stop,start,removeAllMessages"/>

      <properties>
        <property name="InMemory"
                  description="In Memory"/>

        <property name="RedeliveryDelay"
                  description="Redelivery Delay"/>

        <property name="RedeliveryLimit"
                  description="Redelivery Limit"/>

        <property name="MaxDepth"
                  description="Max Depth"/>

        <property name="JNDIName"
                  description="JNDI Name"/>
      </properties>

      <metric name="Availability"
              template="${OBJECT_NAME}:StateString"
              indicator="true"/>

      <metric name="Messages in Queue"
              template="${OBJECT_NAME}:QueueDepth"
              category="THROUGHPUT"
              indicator="true"/>

      <metric name="Receivers Count"
              template="${OBJECT_NAME}:ReceiversCount"
              indicator="true"/>

      <metric name="Scheduled Message Count"
              template="${OBJECT_NAME}:ScheduledMessageCount"/>
    </service>

    <service name="JMS Topic" internal="true">
      <config>
        <option name="name"
                description="JMS Topic"
                default=""/>
      </config>

      <property name="OBJECT_NAME"
                value="jboss.mq.destination:service=Topic,name=%name%"/>

      <plugin type="autoinventory"/>

      <plugin type="control"
              class="JBossStateServiceControlPlugin"/>

      <actions include="stop,start,removeAllMessages"/>

      <properties>
        <property name="InMemory"
                  description="In Memory"/>

        <property name="RedeliveryDelay"
                  description="Redelivery Delay"/>

        <property name="RedeliveryLimit"
                  description="Redelivery Limit"/>

        <property name="MaxDepth"
                  description="Max Depth"/>

        <property name="JNDIName"
                  description="JNDI Name"/>
      </properties>

      <metric name="Availability"
              template="${OBJECT_NAME}:StateString"
              indicator="true"/>

      <metric name="All Subscriptions Count"
              template="${OBJECT_NAME}:AllSubscriptionsCount"
              category="UTILIZATION"
              indicator="true"/>

      <metric name="Non Durable Subscriptions Count"
              template="${OBJECT_NAME}:NonDurableSubscriptionsCount"
              category="UTILIZATION"/>

      <metric name="Durable Subscriptions Count"
              template="${OBJECT_NAME}:DurableSubscriptionsCount"
              category="UTILIZATION"
              indicator="true"/>

      <metric name="All Message Count"
              template="${OBJECT_NAME}:AllMessageCount"
              category="THROUGHPUT"
              indicator="true"/>

      <metric name="Durable Message Count"
              template="${OBJECT_NAME}:DurableMessageCount"
              category="THROUGHPUT"
              indicator="true"/>

      <metric name="NonDurableMessageCount"
              template="${OBJECT_NAME}:NonDurableMessageCount"
              category="THROUGHPUT"/>
    </service>

    <service name="JCA Connection Pool" internal="true">
      <config>
        <option name="jca.connpool"
                description="JCA Connection Pool"
                default=""/>
      </config>

      <properties>
        <property name="Criteria"
                  description="Connection Pool Criteria"/>
      </properties>

      <plugin type="control"
              class="JBossJCAControlPlugin"/>

      <actions include="stop,start,restart,flush"/>
    </service>
  </server>

  <server name="JBoss"
          version="4.0"
          include="3.2">

    <plugin type="measurement"
            class="JBoss4MeasurementPlugin"/>

    <service name="JCA Data Source">
      <config>
        <option name="name"
                description="JNDI Name"
                default="DefaultDS"/>
      </config>

      <property name="OBJECT_NAME"
                value="jboss.jca:name=%name%,service=DataSourceBinding"/>

      <metric name="Availability"
              template="${OBJECT_NAME}:StateString"
              indicator="true"/>

      <plugin type="autoinventory"/>

      <plugin type="control"
              class="JBossStateServiceControlPlugin"/>
      <actions include="stop,start"/>
    </service>

    <service name="EJB3">
      <config>
        <option name="module"
                description="Module Name"
                default="EJB3Trail-ejb3.ejb3"/>
      </config>

      <property name="OBJECT_NAME"
                value="jboss.j2ee:module=%module%,service=EJB3"/>

      <metric name="Availability"
              template="${OBJECT_NAME}:StateString"
              indicator="true"/>

      <plugin type="autoinventory"/>

      <plugin type="control"
              class="JBossStateServiceControlPlugin"/>
      <actions include="stop,start"/>
    </service>
  </server>

  <server name="JBoss"
          version="4.2"
          include="4.0">

    <service name="JGroups Channel">
      <property name="OBJECT_NAME"
                value="jboss.jgroups:type=channel,cluster=%cluster%"/>

      <plugin type="autoinventory"/>

      <config>
        <option name="cluster"
                description="Cluster Name"
                default="DefaultCluster"/>
      </config>
    </service>
  </server>
</plugin>

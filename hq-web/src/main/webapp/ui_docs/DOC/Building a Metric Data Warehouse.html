<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
    <head>
        <title>vFabric Hyperic 4.6.5 : Building a Metric Data Warehouse</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            vFabric Hyperic 4.6.5 : Building a Metric Data Warehouse
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Jan 04, 2012 by <font color="#0050B2">mmcgarry</font>.
				    </div>

				    <p>Hyperic's retention strategy for measurement data is it to store the minimum amount of data that enables it to pinpoint when change in performance or availability occur. Detailed measurement data is stored for a limited period of time - two days, by default - after which the data is compressed and archived as hourly averages with highs and lows. You can configure Hyperic to keep detailed measurement data for longer, up to a maximum of 7 days.</p>

<p>To support requirements for trend analysis over a longer time frame, vFabric Hyperic provides the MetricDataReplicator class, which you can use to replicate uncompressed measurement data in a secondary database.</p>
<style type='text/css'>/*<![CDATA[*/
div.rbtoc1325699600300 {margin-left: 1.5em;padding: 0px;}
div.rbtoc1325699600300 ul {list-style: disc;margin-left: 0px;padding-left: 20px;}
div.rbtoc1325699600300 li {margin-left: 0px;padding-left: 0px;}

/*]]>*/</style><div class='rbtoc1325699600300'>
<ul>
    <li><a href='#BuildingaMetricDataWarehouse-MetricReplicationStrategyOverview'>Metric Replication Strategy Overview</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-InstructionsforEstablishingSecondaryMySQLDatabaseforMetrics'>Instructions for Establishing Secondary MySQL Database for Metrics</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-SetUptheSecondaryDatabase'>Set Up the Secondary Database</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-TesttheNewViews'>Test the New Views</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-SetuptheMetricDataReplicator'>Set up the Metric Data Replicator</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-Createlog4jPropertiesFile'>Create log4j Properties File</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-CreateScripttoRuntheReplicationProcess'>Create Script to Run the Replication Process</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-RuntheReplicationProcess'>Run the Replication Process</a></li>
    <li><a href='#BuildingaMetricDataWarehouse-VerifytheReplicationProcessResults'>Verify the Replication Process Results</a></li>
</ul></div>


<h1><a name="BuildingaMetricDataWarehouse-MetricReplicationStrategyOverview"></a>Metric Replication Strategy Overview</h1>

<p>Detailed steps for creating and populating a secondary database for detailed metrics are provided in the sections that follow. This is a summary of the approach:</p>
<ul>
	<li>A secondary database instance is configured to store detailed measurement data replicated from the primary Hyperic database. The secondary database contains one table, EAM_MEASUREMENT_DATA. This guide currently only covers MySQL, adjustments will need to be made for Oracle and PostgreSQL.</li>
</ul>


<ul>
	<li>The secondary database has a database link to the primary Hyperic database, and five views that point to the primary Hyperic database for resource inventory data. The resource inventory data does not physically reside on the secondary database. The database link to the main database allows views on the secondary database to access inventory data in the primary Hyperic database. These are the views that are required on the secondary database:
	<ul>
		<li>EAM_PLATFORM</li>
		<li>EAM_SERVER</li>
		<li>EAM_SERVICE</li>
		<li>EAM_RESOURCE</li>
		<li>EAM_MEASUREMENT_TEMPL</li>
		<li>EAM_MEASUREMENT</li>
	</ul>
	</li>
</ul>


<p>For documentation on these database tables, see <a href="Hyperic Database Table Schemas.html" title="Hyperic Database Table Schemas">Hyperic Database Table Schemas</a>.</p>

<h1><a name="BuildingaMetricDataWarehouse-InstructionsforEstablishingSecondaryMySQLDatabaseforMetrics"></a>Instructions for Establishing Secondary MySQL Database for Metrics</h1>

<p>These sections below have instructions for configuring a secondary Hyperic database for metrics on MySQL.</p>

<p>Note: MySQL's query optimizer has limitations that have negative impact on the the performance of Hyperic's metric replicator class. This performance degradation can have a ripple effect on the performance of your primary Hyperic database during metric replication as such the replicator class should be ran against a slave mysql db for optimum performance. This document is written around the use of the slave DB.</p>

<h1><a name="BuildingaMetricDataWarehouse-SetUptheSecondaryDatabase"></a>Set Up the Secondary Database</h1>

<p>Perform the steps below to create the secondary database and configure access to your primary Hyperic database. All of the steps in this section apply to the secondary database.</p>

<div class='panelMacro'><table class='noteMacro'><colgroup><col width='24'><col></colgroup><tr><td valign='top'><img src="images/icons/emoticons/warning.gif" width="16" height="16" align="absmiddle" alt="" border="0"></td><td>Another option would be to use MySQL federated tables</td></tr></table></div>


<ol>
	<li>Install your secondary MySQL Database Server and setup replication.</li>
	<li>Create user and database for warehouse
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>CREATE DATABASE hqdata;
GRANT ALL ON hqdata.* to hqdata identified by 'password';
FLUSH PRIVILEGES;
USE hqdata;
</pre>
</div></div></li>
	<li>Create table for measurements
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create table EAM_MEASUREMENT_DATA
(
            TIMESTAMP bigint,
            MEASUREMENT_ID int,
            VALUE numeric(24, 5),
            primary key (TIMESTAMP, MEASUREMENT_ID)
);
</pre>
</div></div></li>
	<li>Create view measurements, replace hqdb with your  Hyperic Db name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view EAM_MEASUREMENT 
 as select ID,
            VERSION_COL,  
            INSTANCE_ID,  
            TEMPLATE_ID,  
            MTIME,  
            ENABLED,  
            COLL_INTERVAL,  
            DSN  
            from hqdb.EAM_MEASUREMENT;
</pre>
</div></div></li>
	<li>Create view for platforms, replace hqdb with your Hyperc DB name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view EAM_PLATFORM
 as select ID,
           VERSION_COL,
           FQDN,
           CERTDN,
           DESCRIPTION,
           CTIME,
           MTIME,
           MODIFIED_BY,
           LOCATION,
           COMMENT_TEXT,
           CPU_COUNT,
           PLATFORM_TYPE_ID,
           CONFIG_RESPONSE_ID,
           AGENT_ID,
           RESOURCE_ID
           from hqdb.EAM_PLATFORM;
</pre>
</div></div></li>
	<li>Create view for servers, replace hqdb with your Hypierc DB name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view EAM_SERVER as
  select ID,
           VERSION_COL,
           DESCRIPTION,
           CTIME,
           MTIME,
           MODIFIED_BY,
           LOCATION,
           PLATFORM_ID,
           AUTOINVENTORYIDENTIFIER,
           RUNTIMEAUTODISCOVERY,
           WASAUTODISCOVERED,
           SERVICESAUTOMANAGED,
           AUTODISCOVERY_ZOMBIE,
           INSTALLPATH,
           SERVER_TYPE_ID,
           CONFIG_RESPONSE_ID,
           RESOURCE_ID
           from hqdb.EAM_SERVER;
</pre>
</div></div></li>
	<li>Create view for services, replace hqdb with your Hyperic DB name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view EAM_SERVICE as
  select ID,
           VERSION_COL,
           DESCRIPTION,
           CTIME,
           MTIME,
           MODIFIED_BY,
           LOCATION,
           AUTODISCOVERY_ZOMBIE,
           SERVICE_RT,
           ENDUSER_RT,
           PARENT_SERVICE_ID,
           SERVER_ID,
           SERVICE_TYPE_ID,
           CONFIG_RESPONSE_ID,
           RESOURCE_ID
           from hqdb.EAM_SERVICE;
</pre>
</div></div></li>
	<li>Create view for resources, replace hqdb with your  Hyperic Db name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view EAM_RESOURCE
 as select ID,
           VERSION_COL,
           RESOURCE_TYPE_ID,
           INSTANCE_ID,
           SUBJECT_ID,
           PROTO_ID,
           NAME,
           SORT_NAME,
           FSYSTEM,
           MTIME 
           from hqdb.EAM_RESOURCE;
</pre>
</div></div></li>
	<li>Create view for measurement templates, replace hqdb with your Hyperic DB name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view EAM_MEASUREMENT_TEMPL as
  select ID,
           VERSION_COL,
           NAME,
           ALIAS,
           UNITS,
           COLLECTION_TYPE,
           DEFAULT_ON,
           DEFAULT_INTERVAL,
           DESIGNATE,
           TEMPLATE,
           PLUGIN,
           CTIME,
           MTIME,
           MONITORABLE_TYPE_ID,
           CATEGORY_ID
           from hqdb.EAM_MEASUREMENT_TEMPL;
</pre>
</div></div></li>
	<li>OPTIONAL: Create view for Availability data, replace hqdb with your Hyperic DB name
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>create view HQ_AVAIL_DATA_RLE
 as select MEASUREMENT_ID,
            STARTIME,     
            ENDTIME,      
            AVAILVAL      
            from hqdb.HQ_AVAIL_DATA_RLE;
</pre>
</div></div>
<p>Availability isn't replicated as it is stored differently and doesn't have compression. This view is provided as an example if you want to query a single db for availability data. </p></li>
</ol>


<h1><a name="BuildingaMetricDataWarehouse-TesttheNewViews"></a>Test the New Views</h1>

<p>To verify the views you created work, you can run a query that lists all servers in the database. Enter the following query at the mysql prompt of the secondary database and to list all of the servers. This query runs against the hqdb database.</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>SELECT * FROM EAM_SERVER;
</pre>
</div></div>

<h1><a name="BuildingaMetricDataWarehouse-SetuptheMetricDataReplicator"></a>Set up the Metric Data Replicator</h1>

<p>Once your secondary database is ready to store and view the Hypierc data, you must set up the metric_replicator.properties file with the appropriate parameters. Create a directory where the replicator files will be stored, for instance:<br/>
/usr/hyperic/replicator</p>
<div class='table-wrap'>
<table class='confluenceTable'><tbody>
<tr>
<th class='confluenceTh'> <b>Property Setting</b> </th>
<th class='confluenceTh'> <b>Description</b> </th>
</tr>
<tr>
<td class='confluenceTd'> pri_user=hqadmin </td>
<td class='confluenceTd'> Primary database username </td>
</tr>
<tr>
<td class='confluenceTd'> pri_pass=hqadmin </td>
<td class='confluenceTd'> Primary database password </td>
</tr>
<tr>
<td class='confluenceTd'> pri_url=jdbc:mysql://&lt;ipaddress&gt;:&lt;port&gt;/hqdb </td>
<td class='confluenceTd'> Connection string for primary server, including IP Address and port </td>
</tr>
<tr>
<td class='confluenceTd'> sec_user=hqdata </td>
<td class='confluenceTd'> Secondary database username </td>
</tr>
<tr>
<td class='confluenceTd'> sec_pass=password </td>
<td class='confluenceTd'> Secondary database password </td>
</tr>
<tr>
<td class='confluenceTd'> sec_url=jdbc:mysql://&lt;ipaddress&gt;:&lt;port&gt;/hqdata? </td>
<td class='confluenceTd'> Connection string for secondary server, including IP Address and port. </td>
</tr>
<tr>
<td class='confluenceTd'> interval </td>
<td class='confluenceTd'> Time interval in minutes. Use to specify the interval the script runs at. Default: 90 </td>
</tr>
<tr>
<td class='confluenceTd'> time_chunk </td>
<td class='confluenceTd'> Amount of minutes to do during this run. Default: 90 </td>
</tr>
<tr>
<td class='confluenceTd'> batch_size </td>
<td class='confluenceTd'> Number of metrics do to in a batch. Default: 2000 </td>
</tr>
</tbody></table>
</div>


<h1><a name="BuildingaMetricDataWarehouse-Createlog4jPropertiesFile"></a>Create log4j Properties File</h1>

<p>Create a file called log4j.properties in the replicator directory you created in the previous step and paste this text into the file:</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>log4j.rootLogger=DEBUG, R
log4j.appender.R=org.apache.log4j.ConsoleAppender
log4j.appender.R.layout=org.apache.log4j.PatternLayout
log4j.appender.R.layout.ConversionPattern=%d \[PRIVATE:%t\] %-5p %c - %m%n
</pre>
</div></div>

<h1><a name="BuildingaMetricDataWarehouse-CreateScripttoRuntheReplicationProcess"></a>Create Script to Run the Replication Process</h1>

<p>Create a file called <tt>run.sh</tt>, which will be the script that runs the replication process. Copy the commands shown below, changing the values of <tt>JAVA_HOME</tt> and <tt>SERVER_HOME</tt> to point to your Java and Hyperic Server installations respectively.</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>#!/bin/bash

#update these params
SERVER_HOME="/opt/vmware/vfabric/hyperic/server/active/hq-engine/hq-server"

# props file which configures the replicator
PROPS="metric_replicator"

HQ_ROOT="$SERVER_HOME/webapps/ROOT"

# path to the prop files
# update to reflect appropriate database
PROP_FILES="."
DB_PKGS="$HQ_ROOT/WEB-INF/lib/mysql-connector-java-commercial-5.1.10.jar"
HQ_PKGS="$HQ_ROOT/WEB-INF/lib/hq-common-4.5.jar"
LOG_PKGS="$HQ_ROOT/WEB-INF/lib/commons-logging-1.0.4.jar:$HQ_ROOT/WEB-INF/lib/log4j-1.2.14.jar"
HQEE_PKGS="$HQ_ROOT/WEB-INF/lib/hqee-server-4.5.jar"
HQUTIL_PKGS="$HQ_ROOT/WEB-INF/lib/hq-util-4.5.jar"
PKGS="$PROP_FILES:$DB_PKGS:$HQ_PKGS:$HQEE_PKGS:$LOG_PKGS:$HQUTIL_PKGS"
ARGS="$LOG_ARGS -Dreplprops=$PROPS -Djdbc.drivers=com.mysql.jdbc.Driver -cp $PKGS"
JAVA="$JAVA_HOME/bin/java"

set -x

$JAVA $ARGS com.hyperic.hq.measurement.shared.MetricDataReplicator
</pre>
</div></div>

<h1><a name="BuildingaMetricDataWarehouse-RuntheReplicationProcess"></a>Run the Replication Process</h1>

<p>To run the replication process, open a terminal window and enter:</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>run.sh
</pre>
</div></div>

<h1><a name="BuildingaMetricDataWarehouse-VerifytheReplicationProcessResults"></a>Verify the Replication Process Results</h1>

<p>Run the queries in the following sections to verify that the replication process succeeded.</p>

<h2><a name="BuildingaMetricDataWarehouse-Query1Showallthediskstats"></a>Query 1 - Show all the disk stats</h2>

<p>Run the following query to show all metrics whose name contains the string "disk", replacing the your.platform.nam below with a valid platform name in your resource inventory.</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>SELECT p.fqdn, 
r.name, 
t.name, 
d.value, 
d.timestamp 
from EAM_MEASUREMENT_TEMPL t, 
EAM_MEASUREMENT m, 
EAM_MEASUREMENT_DATA d,  
EAM_SERVER s, 
EAM_PLATFORM p, 
EAM_RESOURCE r 
where t.id = m.template_id AND 
m.id = d.measurement_id AND 
p.id = s.platform_id AND 
r.instance_id = m.instance_id AND 
lower(p.fqdn) = 'your.platform.name' AND 
lower(r.name) LIKE '%Mount%'  
ORDER BY d.timestamp DESC;
</pre>
</div></div>

<h2><a name="BuildingaMetricDataWarehouse-Query2ComponentServiceUsageInformationforServersandServices"></a>Query 2 - Component Service Usage Information for Servers and Services</h2>

<p>Once the appropriate join has been made to access the server or service layer, filtering by server or service name or metric template is the easiest way to select specific metrics of interest per server or service. (Meaning "server" and "service", as defined in the HQ inventory model.) For example, JBoss is a server while the individual web applications running within the container are services. Metrics specific to the JBoss container are available from the server layer while the internal web applications are available via the service layer.</p>
<div class="preformatted panel" style="border-width: 1px;"><div class="preformattedContent panelContent">
<pre>SELECT platform.fqdn, 
resource.name, 
template.name, 
data.value, 
data.timestamp 
FROM EAM_MEASUREMENT_TEMPL template, 
EAM_MEASUREMENT measurement, 
EAM_MEASUREMENT_DATA data, 
EAM_SERVICE service, 
EAM_SERVER server, 
EAM_PLATFORM platform, 
EAM_RESOURCE resource 
WHERE 1=1 AND 
template.id = measurement.template_id AND 
measurement.id = data.measurement_id AND 
platform.id = server.platform_id AND 
server.id = service.server_id AND 
service.id = measurement.instance_id AND 
lower(platform.fqdn) = 'your.platform.name' AND 
lower(resource.name) like '%jboss%' 
AND lower(template.name) like '%transaction count%' 
ORDER BY data.timestamp desc;
</pre>
</div></div>





				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="http://support.hyperic.com/images/border/border_bottom.gif"><img src="images/border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Jan 20, 2012 10:07</font></td>
		    </tr>
	    </table>
    </body>
</html>
